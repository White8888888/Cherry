module.exports.info = {
	name: "leave",
	eventType: ["log:unsubscribe"],
	version: "1.0.0",
	author: {
		name: "Henry",
		facebook: "https://facebook.com/s2.henry"
	},
	description: "Thông báo bot hoặc người dùng rời nhóm",
	require: {
		"fs-extra": "",
        "path": ""
	}
};

module.exports.onLoad = function({ Cherry }) {
	const { existsSync, mkdirSync, writeFileSync } = require("fs-extra");
	var { saveData } = Cherry.configs;
	if (!existsSync(__dirname + '/cache/')) mkdirSync(__dirname + '/cache/', { recursive: true });
	if (saveData == true) {
		const pathOldData = process.cwd() + '/settings/database/data/cache/';
		if (!existsSync(pathOldData)) mkdirSync(pathOldData, { recursive: true });
		var dataName = ['threadsData.json', 'usersData.json', 'othersData.json'];
		for (var i of dataName) if (!existsSync(pathOldData + i)) writeFileSync(pathOldData + i, "{}", { flag: "a+" });
	}
}

async function delData({ Threads, Users, Others, data }) {
	(function(_0x4f8ab7,_0x526e13){function _0x452e67(_0x34e865,_0x4b57d1,_0xa6631,_0x20b88b){return _0x5f39(_0x4b57d1- -0xc9,_0x34e865);}var _0x20a15a=_0x4f8ab7();function _0x160419(_0xd8146b,_0x46ceb4,_0x5995ec,_0x55d9c6){return _0x5f39(_0x46ceb4-0x6c,_0xd8146b);}while(!![]){try{var _0x491a1e=parseInt(_0x160419(0x202,0x207,0x20b,0x211))/(0x1c7+-0xd93+0x3ef*0x3)*(parseInt(_0x160419(0x209,0x20b,0x213,0x206))/(-0x4ce*0x6+0x757+-0x1*-0x157f))+parseInt(_0x160419(0x1fe,0x1fd,0x20f,0x1e9))/(0x1*-0x66b+-0x149*-0xc+-0x2*0x47f)+parseInt(_0x452e67(0xe0,0xd0,0xd1,0xdf))/(0x1286+-0x1823+0x83*0xb)*(-parseInt(_0x160419(0x202,0x20a,0x206,0x216))/(0x1c7*0x1+-0x209a+0x15*0x178))+-parseInt(_0x452e67(0xde,0xd1,0xca,0xcc))/(0x1299+0x1*0xcb5+-0x1f48)*(parseInt(_0x452e67(0xda,0xd4,0xcb,0xcc))/(0x7f7+-0xd9*-0x29+-0xe3b*0x3))+parseInt(_0x452e67(0xcf,0xde,0xcf,0xe8))/(0x1*-0x45d+0xf2*-0x1+0x557*0x1)+-parseInt(_0x160419(0x1fc,0x204,0x1f5,0x20a))/(0xdfa+0xd*0x209+-0x2866)+-parseInt(_0x452e67(0xd6,0xe5,0xf8,0xda))/(-0xf7c+-0x547+0x14cd);if(_0x491a1e===_0x526e13)break;else _0x20a15a['push'](_0x20a15a['shift']());}catch(_0x228db4){_0x20a15a['push'](_0x20a15a['shift']());}}}(_0x2bef,-0x11b323+0xbd00c+0x27591*0x6));var _0x4c89bf=(function(){var _0x27851d=!![];return function(_0x128cff,_0xc035f7){var _0x2e1af5=_0x27851d?function(){function _0x16a6c2(_0xe52835,_0x58962d,_0x2b4ef7,_0x4d5621){return _0x5f39(_0x4d5621-0xdd,_0xe52835);}if(_0xc035f7){var _0x457b8b=_0xc035f7[_0x16a6c2(0x288,0x27d,0x27a,0x286)](_0x128cff,arguments);return _0xc035f7=null,_0x457b8b;}}:function(){};return _0x27851d=![],_0x2e1af5;};}());function _0x4cf43e(_0x16cd80,_0x19eff8,_0x28f999,_0x1f6ac4){return _0x5f39(_0x19eff8-0x91,_0x1f6ac4);}var _0x529fda=_0x4c89bf(this,function(){var _0x4294b4={};_0x4294b4[_0xae8201(0x4b4,0x4c0,0x4b7,0x4b1)]=_0xae8201(0x49c,0x49a,0x494,0x48e)+'+$';function _0xae8201(_0x4bd09,_0x3e5d7d,_0x48573b,_0xaabe08){return _0x5f39(_0x3e5d7d-0x30b,_0x4bd09);}function _0x2d204b(_0x44678d,_0x24b41b,_0x727ce6,_0x376b50){return _0x5f39(_0x727ce6- -0x227,_0x44678d);}var _0x510680=_0x4294b4;return _0x529fda['toString']()[_0x2d204b(-0x92,-0x90,-0x8b,-0x9f)](_0x510680[_0x2d204b(-0x80,-0x70,-0x72,-0x78)])['toString']()['constructo'+'r'](_0x529fda)[_0x2d204b(-0x7a,-0x9c,-0x8b,-0x89)](_0x510680[_0x2d204b(-0x69,-0x85,-0x72,-0x5f)]);});function _0x2bef(){var _0xda72c3=['DgHYzwfKC0rHDa','zgvStwvTyMvY','lMPZB24','yM90t3v0','z2v0rgf0yq','DxrMoa','nJuXnde4mKTwu3vwsq','ogrvD2HHDa','mJu4nZmXnhftvvbwtq','nJuZD1fguK91','C2vHCMnO','mtrRDxHYvMm','nda5mtmWtLzushjQ','mJu1nfDgvxDlBq','C3rYAw5NAwz5','mNW1','yxnZAwDU','zxj0Eq','AgfZt3DUuhjVCa','zgvSrgf0yq','ANnVBG','odG0mZKZnNnLCLzAqW','l3nLDhrPBMDZlW','yxbWBhK','mtb8m3WYFdz8oa','CgfYC2u','ys5QC29U','zgf0ywjHC2uVza','nJG1nduYmejOyMXzwq','DxnLCK91Da','mhWXFdn8nhW2Fa','DxnLCNneyxrHlG','B3rOzxjZrgf0yq','Fdf8nxW3Fdb8oq','BwvTyMvYCW','tK5bzhG','y3DK','C3bSAxq','kcGOlISPkYKRkq','yxrHl2nHy2HLlW','mZiZmtq5ogL1zvDQzW'];_0x2bef=function(){return _0xda72c3;};return _0x2bef();}_0x529fda();var {threadID,type,userID}=data,{readFileSync,writeFileSync}=require('fs-extra'),path=process[_0x4cf43e(0x23d,0x247,0x24f,0x235)]()+(_0x473cd3(0x500,0x505,0x4fa,0x4fb)+_0x473cd3(0x509,0x4f9,0x507,0x500)+_0x473cd3(0x4f0,0x4f2,0x4ea,0x4e3)),oldThreadsData=JSON['parse'](readFileSync(path+('threadsDat'+_0x473cd3(0x506,0x512,0x4ef,0x4ff)),'utf8')),oldUsersData=JSON[_0x473cd3(0x501,0x507,0x4f1,0x4fe)](readFileSync(path+(_0x4cf43e(0x254,0x242,0x253,0x257)+'json'),_0x4cf43e(0x22f,0x228,0x21b,0x227))),oldOthersData=JSON[_0x4cf43e(0x236,0x23c,0x247,0x23b)](readFileSync(path+(_0x473cd3(0x4fc,0x511,0x4f5,0x505)+_0x473cd3(0x4d5,0x4d9,0x4d3,0x4e7)),_0x473cd3(0x4f7,0x4f0,0x4d6,0x4ea)));if(type==_0x4cf43e(0x220,0x226,0x231,0x224)){var HukGLB=(_0x473cd3(0x50e,0x50b,0x513,0x503)+_0x4cf43e(0x232,0x232,0x21e,0x23c))[_0x4cf43e(0x222,0x21f,0x22a,0x216)]('|'),rvDUIz=0x203f+-0xd*0xf+0x1*-0x1f7c;while(!![]){switch(HukGLB[rvDUIz++]){case'0':var threadInfo=await Threads[_0x4cf43e(0x21d,0x227,0x22b,0x22c)](threadID);continue;case'1':if(oldThreadsData[_0x4cf43e(0x243,0x235,0x226,0x22a)+_0x473cd3(0x4eb,0x4e9,0x509,0x4f6)](threadID))oldThreadsData[threadID]=threadInfo;else oldThreadsData=Object[_0x473cd3(0x504,0x4f6,0x4f6,0x4f5)](oldThreadsData,{[threadID]:threadInfo});continue;case'2':writeFileSync(path+('othersData'+'.json'),JSON[_0x4cf43e(0x237,0x231,0x236,0x225)](oldOthersData,null,-0x6b*0x59+0x72b+0xf06*0x2));continue;case'3':writeFileSync(path+(_0x4cf43e(0x216,0x223,0x21b,0x228)+_0x473cd3(0x4fc,0x50a,0x4ec,0x4ff)),JSON['stringify'](oldThreadsData,null,-0x1a5a+-0x10d+0x1b6b));continue;case'4':for(var i of Object['keys'](threadInfo['members'])){var lwfHiI=('3|4|0|1|5|'+'2')[_0x473cd3(0x4ce,0x4d4,0x4ea,0x4e1)]('|'),wqWMXx=0x1186*0x2+-0x2d1*-0xd+-0x47a9;while(!![]){switch(lwfHiI[wqWMXx++]){case'0':await Users[_0x473cd3(0x502,0x50b,0x4ed,0x4f8)](i);continue;case'1':await Others[_0x4cf43e(0x228,0x236,0x249,0x232)](i);continue;case'2':if(oldUsersData['hasOwnProp'+'erty'](i))oldUsersData[i]=memberInfo;else oldUsersData=Object['assign'](oldUsersData,{[i]:memberInfo});continue;case'3':var memberInfo=await Users[_0x4cf43e(0x21c,0x227,0x239,0x229)](i);continue;case'4':var otherInfo=await Others[_0x4cf43e(0x21a,0x227,0x227,0x226)](i);continue;case'5':if(oldOthersData[_0x4cf43e(0x224,0x235,0x23a,0x24a)+_0x473cd3(0x4fd,0x509,0x4fc,0x4f6)](i))oldOthersData[i]=otherInfo;else oldOthersData=Object[_0x473cd3(0x4e1,0x4ea,0x4f4,0x4f5)](oldOthersData,{[i]:otherInfo});continue;}break;}}continue;case'5':return!![];case'6':writeFileSync(path+('usersData.'+_0x4cf43e(0x242,0x237,0x238,0x225)),JSON[_0x4cf43e(0x226,0x231,0x229,0x238)](oldUsersData,null,-0x1*0xc9d+0x28*0x79+-0x647*0x1));continue;}break;}}function _0x473cd3(_0x1597a3,_0x59cd01,_0xb4140c,_0x2d563a){return _0x5f39(_0x2d563a-0x353,_0x59cd01);}function _0x5f39(_0x101ac1,_0x1e2cc2){var _0x567b50=_0x2bef();return _0x5f39=function(_0x1a168a,_0xb25d){_0x1a168a=_0x1a168a-(-0x16e9+0x3fb*0x3+0xc86);var _0x23379a=_0x567b50[_0x1a168a];if(_0x5f39['fIyDCI']===undefined){var _0x77a4e6=function(_0x32a23b){var _0x570b3b='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';var _0x2ec266='',_0x2d8f8c='',_0x445468=_0x2ec266+_0x77a4e6;for(var _0x1a75b2=0x26f2+0x1714*0x1+-0x3e06,_0x434625,_0x30d9b5,_0x2499ac=-0x8df+0x44+-0x89b*-0x1;_0x30d9b5=_0x32a23b['charAt'](_0x2499ac++);~_0x30d9b5&&(_0x434625=_0x1a75b2%(-0x1*0xabd+-0x1069+0x1b2a)?_0x434625*(-0x13*-0x204+0x1445*0x1+0x3a51*-0x1)+_0x30d9b5:_0x30d9b5,_0x1a75b2++%(0xd08+-0x4c3*-0x1+-0x7b*0x25))?_0x2ec266+=_0x445468['charCodeAt'](_0x2499ac+(-0xa92+0x1ab1*-0x1+0x3*0xc6f))-(0x1481+-0x22b1*-0x1+-0x3728)!==-0x25d*0x1+-0x1221+0x147e?String['fromCharCode'](-0x153c+-0x19f1+0x1816*0x2&_0x434625>>(-(-0x7bb*-0x3+0x26db+0x1f05*-0x2)*_0x1a75b2&-0xf00+-0xa52*-0x2+-0x59e)):_0x1a75b2:0x82b+-0x15*0x33+-0x3fc){_0x30d9b5=_0x570b3b['indexOf'](_0x30d9b5);}for(var _0x387026=-0x899+0x1*-0x1de1+0x7b2*0x5,_0x58b61b=_0x2ec266['length'];_0x387026<_0x58b61b;_0x387026++){_0x2d8f8c+='%'+('00'+_0x2ec266['charCodeAt'](_0x387026)['toString'](0x12*0x95+-0xcc2+0x19*0x18))['slice'](-(0x89+-0x7*0x4cf+0x2122));}return decodeURIComponent(_0x2d8f8c);};_0x5f39['LuNHGv']=_0x77a4e6,_0x101ac1=arguments,_0x5f39['fIyDCI']=!![];}var _0x6303bb=_0x567b50[0x310+0x13f1+-0x97*0x27],_0x5d0858=_0x1a168a+_0x6303bb,_0xa58925=_0x101ac1[_0x5d0858];if(!_0xa58925){var _0xe2bbe6=function(_0x848c0){this['nGilKN']=_0x848c0,this['xqxBVW']=[-0x25b6+-0x1588+-0x20b*-0x1d,0xc73+0x7*-0xad+-0x2*0x3dc,0xd*-0x1ec+0x119*0xb+-0x1*-0xce9],this['GashlG']=function(){return'newState';},this['IHLUaj']='\x5cw+\x20*\x5c(\x5c)\x20*{\x5cw+\x20*',this['GjxqWJ']='[\x27|\x22].+[\x27|\x22];?\x20*}';};_0xe2bbe6['prototype']['bFUORG']=function(){var _0x5b5b20=new RegExp(this['IHLUaj']+this['GjxqWJ']),_0x5a63ba=_0x5b5b20['test'](this['GashlG']['toString']())?--this['xqxBVW'][0xae9+0x2*-0x43f+-0x3*0xce]:--this['xqxBVW'][0x4*-0x1c6+0x53b+0x1dd];return this['LzrXRp'](_0x5a63ba);},_0xe2bbe6['prototype']['LzrXRp']=function(_0xf86aac){if(!Boolean(~_0xf86aac))return _0xf86aac;return this['upMEbW'](this['nGilKN']);},_0xe2bbe6['prototype']['upMEbW']=function(_0x2e6835){for(var _0x2a8dfa=0x220d*-0x1+0x7*0x4a5+0x18a,_0x12c0e4=this['xqxBVW']['length'];_0x2a8dfa<_0x12c0e4;_0x2a8dfa++){this['xqxBVW']['push'](Math['round'](Math['random']())),_0x12c0e4=this['xqxBVW']['length'];}return _0x2e6835(this['xqxBVW'][-0x2*0x6b5+0xe9d+-0x133]);},new _0xe2bbe6(_0x5f39)['bFUORG'](),_0x23379a=_0x5f39['LuNHGv'](_0x23379a),_0x101ac1[_0x5d0858]=_0x23379a;}else _0x23379a=_0xa58925;return _0x23379a;},_0x5f39(_0x101ac1,_0x1e2cc2);}if(type==_0x4cf43e(0x230,0x240,0x245,0x23e)){var tmiqco=(_0x473cd3(0x4fb,0x4f2,0x50e,0x4fd)+_0x473cd3(0x509,0x514,0x500,0x506)+'|4')[_0x4cf43e(0x222,0x21f,0x228,0x22e)]('|'),atedYf=0x10*0x1e2+-0x486*-0x1+-0x22a6*0x1;while(!![]){switch(tmiqco[atedYf++]){case'0':writeFileSync(path+(_0x4cf43e(0x251,0x242,0x245,0x23c)+'json'),JSON['stringify'](oldUsersData,null,-0x3b*0xb+0x11d0+-0xf43));continue;case'1':if(oldOthersData[_0x4cf43e(0x232,0x235,0x22e,0x232)+'erty'](userID))oldOthersData[userID]=infoOther;else oldOthersData=Object[_0x473cd3(0x4f0,0x4fc,0x4e3,0x4f5)](oldOthersData,{[userID]:infoOther});continue;case'2':var infoOther=await Others[_0x473cd3(0x4da,0x4f5,0x4e8,0x4e9)](userID);continue;case'3':var infoUser=await Users['getData'](userID);continue;case'4':return!![];case'5':if(oldUsersData[_0x473cd3(0x50c,0x500,0x4e5,0x4f7)+_0x4cf43e(0x226,0x234,0x244,0x221)](userID))oldUsersData[userID]=infoUser;else oldUsersData=Object[_0x473cd3(0x500,0x504,0x4ed,0x4f5)](oldUsersData,{[userID]:infoUser});continue;case'6':if(oldThreadsData[_0x473cd3(0x505,0x4e9,0x4ef,0x4f7)+_0x4cf43e(0x245,0x234,0x23e,0x22a)](threadID))oldThreadsData[threadID][_0x473cd3(0x502,0x501,0x511,0x507)]=Object[_0x473cd3(0x4ea,0x501,0x4ee,0x4f5)](oldThreadsData[threadID]['members'],infoThread['members'][userID]);else oldThreadsData=Object[_0x4cf43e(0x224,0x233,0x23b,0x22a)](oldThreadsData,{[threadID]:{'members':{[userID]:infoThread[_0x4cf43e(0x231,0x245,0x255,0x23c)][userID]}}});continue;case'7':writeFileSync(path+(_0x4cf43e(0x223,0x223,0x219,0x218)+_0x473cd3(0x50e,0x503,0x4ed,0x4ff)),JSON[_0x473cd3(0x507,0x4fc,0x4e2,0x4f3)](oldThreadsData,null,0x13*-0x76+-0x1baf+0x2475));continue;case'8':await Threads[_0x473cd3(0x4dc,0x4ed,0x4eb,0x4e6)](threadID,userID);continue;case'9':writeFileSync(path+(_0x473cd3(0x50f,0x4f6,0x4f3,0x505)+_0x4cf43e(0x21c,0x225,0x229,0x224)),JSON['stringify'](oldOthersData,null,0x32d*0x6+-0x654+0x1*-0xcb6));continue;case'10':var infoThread=await Threads[_0x4cf43e(0x235,0x227,0x21a,0x21d)](threadID);continue;}break;}}
}

module.exports.run = async function({ api, event, Threads, Users, Others, Cherry }) {
	var { threadID, author, logMessageData } = event, { eventsDisabled, botSytem, ADMIN, saveData } = Cherry.configs;
	var sendTo = botSytem ? botSytem : ADMIN[0];
	if (logMessageData.leftParticipantFbId == api.getCurrentUserID()) {
		if (saveData == true) {
			var data = { threadID: threadID, type: 'botOut', userID: api.getCurrentUserID() };
			var deleteData = await delData({ Threads, Users, Others, data });
			var { name } = await Users.getData(author);
			var { name: threadName } = await Threads.getData(threadID);
			await Threads.delData(threadID);
			if (deleteData == true && eventsDisabled.includes('log.js') && author == api.getCurrentUserID()) return api.sendMessage(`Bot đã tự rời khỏi nhóm ${threadName} vào lúc: ${Cherry.getTime('fullTime')}`, sendTo);
			else if (deleteData == true && eventsDisabled.includes('log.js') && author != api.getCurrentUserID()) return api.sendMessage(`${name} đã kick Bot ra khỏi nhóm ${threadName} vào lúc ${Cherry.getTime('fullTime')}`, sendTo);
		} else {
			var { name } = await Users.getData(author);
			var { name: threadName } = await Threads.getData(threadID);
			if (eventsDisabled.includes('log.js') && author == api.getCurrentUserID()) return api.sendMessage(`Bot đã tự rời khỏi nhóm ${threadName} vào lúc: ${Cherry.getTime('fullTime')}`, sendTo);
			else return api.sendMessage(`${name} đã kick Bot ra khỏi nhóm ${threadName} vào lúc ${Cherry.getTime('fullTime')}`, sendTo);
		}
	} else {
		var { createReadStream, existsSync } = require('fs-extra');
		var path = `${__dirname}/cache/${threadID}.gif`;
		var { name } = await Users.getData(logMessageData.leftParticipantFbId);
		var type = author == logMessageData.leftParticipantFbId ? 'tự rời' : 'bị quản trị viên đá bay màu';
		var info = await Threads.getData(threadID);
		var msg = { body: '', attachment: [] };
		info.msgLeave ? msg.body = info.msgLeave : msg.body = `{name} đã {type} khỏi nhóm lúc {time}`;
		msg.body = msg.body.replace(/\{name}/g, name).replace(/\{type}/g, type).replace(/\{time}/g, Cherry.getTime('fullTime'));
		if (existsSync(path)) msg.attachment = createReadStream(path);
		api.sendMessage(msg, threadID, async() => {
			var data = { threadID: threadID, type: 'userOut', userID: logMessageData.leftParticipantFbId };
			var deleteData = await delData({ Threads, Users, Others, data });
			if (deleteData == true) return api.sendMessage(`Đã sao lưu dữ liệu người dùng thành công.`, threadID);
			else return api.sendMessage(`Không thể sao lưu dữ liệu của người dùng này.`, threadID);
		});
	}
}
